#!/usr/bin/bash
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥—ã

echo "–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ø–∏–∏ –º–∏—Ä–∞ –∑–∞–ø—É—â–µ–Ω!"

SERVER_DIR="/root/minecraft/fabric_serv"  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Ä–≤–µ—Ä–∞
WORLD_DIR="$SERVER_DIR/world"  # –ü—É—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–∏—Ä–∞
BACKUP_DIR="$SERVER_DIR/backup"  # –ü—É—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–æ–ø–∏–∏ –º–∏—Ä–∞
BACKUP_NAME="world_backup_$(date +%F_%H-%M-%S).tar.gz"  # –ò–º—è –∫–æ–ø–∏–∏ –º–∏—Ä–∞

# === –ü–†–û–í–ï–†–ö–ê ===
mkdir -p "$BACKUP_DIR"  # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ —Å –∫–æ–ø–∏—è–º–∏ –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç

if [ ! -d "$WORLD_DIR" ]; then  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –º–∏—Ä–∞
    echo "üõ†Ô∏è‚ö†Ô∏è –û–®–ò–ë–ö–ê: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–∏—Ä–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $WORLD_DIR"
    exit 1
fi

echo "–ü—É—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–∏—Ä–∞: $WORLD_DIR"
echo "–ü—É—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–æ–ø–∏–∏ –º–∏—Ä–∞: $BACKUP_DIR"
echo "–ò–º—è –∫–æ–ø–∏–∏ –º–∏—Ä–∞: $BACKUP_NAME"

# === –°–û–ó–î–ê–ù–ò–ï –ê–†–•–ò–í–ê ===
echo "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –∫–æ–ø–∏–∏ –º–∏—Ä–∞"  # –ò–º—è –∞—Ä—Ö–∏–≤–∞ –∫–æ–ø–∏–∏ –º–∏—Ä–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
tar -cf - \
    --exclude='data/DistantHorizons.sqlite' \
    --exclude='data/DistantHorizons.sqlite-shm' \
    --exclude='data/DistantHorizons.sqlite-wal' \
    -C "$WORLD_DIR" . | pv -s $(du -sb "$WORLD_DIR" | awk '{print $1}') | gzip -8 > "$BACKUP_DIR/$BACKUP_NAME"

# –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
if [ $? -eq 0 ]; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –∫–æ–ø–∏–∏ –º–∏—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
else
    echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞"
    exit 1
fi

# === –£–î–ê–õ–ï–ù–ò–ï –°–¢–ê–†–´–• –ê–†–•–ò–í–û–í ===
echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ø–∏–π –º–∏—Ä–∞"
find "$BACKUP_DIR" -name 'world_backup_*.tar.gz' | sort -r | tail -n +6 | xargs rm -f  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ø–∏–π –º–∏—Ä–∞, –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5
# find "$BACKUP_DIR" -type f -name "world_backup_*.tar.gz" -mtime +30 -exec rm {} \;  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ø–∏–π –º–∏—Ä–∞, —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

# === –û–¢–ß–Å–¢ ===
echo "–ù–æ–≤–∞—è –∫–æ–ø–∏—è –º–∏—Ä–∞: $BACKUP_DIR/$BACKUP_NAME"

# === –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö ===
# –î–ê–¢–¨ –ü–†–ê–í–ê –°–ö–†–ò–ü–¢–£:
# chmod +x /root/minecraft/fabric_serv/help/backup.sh
# –ó–ê–ü–£–°–¢–ò–¢–¨
# /root/minecraft/fabric_serv/help/backup.sh